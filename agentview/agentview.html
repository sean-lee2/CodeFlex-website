<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta charset="utf-8"/>

        <title>Agent View - URDF Robot Viewer</title>

        <!-- Import Map for Three.js and Physics -->
        <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.164.1/build/three.module.js",
                "three/examples/jsm/": "https://unpkg.com/three@0.164.1/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
        </script>

        <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.4.3/webcomponents-bundle.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300" rel="stylesheet"/>
        
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Roboto', sans-serif;
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                color: #ffffff;
                overflow: hidden;
                height: 100vh;
            }

            .main-container {
                display: flex;
                height: 100vh;
                width: 100vw;
            }

            .left-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border-right: 2px solid #0f3460;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            }

            .panel-header {
                background: linear-gradient(90deg, #0f3460 0%, #16537e 100%);
                color: #ffffff;
                padding: 15px 20px;
                font-size: 18px;
                font-weight: 300;
                text-align: center;
                border-bottom: 2px solid #0a2a4a;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }

            .viewer-container {
                flex: 1;
                position: relative;
                background: #0a0a0a;
                overflow: hidden;
            }

            urdf-viewer {
                width: 100%;
                height: 100%;
                display: block;
                background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a0a 100%);
            }

            /* üè≠ Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò - Í≥µÏû• ÌÖåÎßà (ÏõêÎ≥∏Í≥º ÎèôÏùº) */
            .factory-loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                opacity: 1;
                transition: opacity 0.5s ease-out;
            }

            .factory-loading.hidden {
                opacity: 0;
                pointer-events: none;
            }

            .company-logo {
                font-size: 72px;
                font-weight: 400;
                font-family: 'Times New Roman', serif;
                margin-bottom: 60px;
                text-align: center;
                letter-spacing: -2px;
                text-transform: none;
                position: relative;
                animation: logoGlow 2s ease-in-out infinite alternate;
                height: 90px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .company-logo::before {
                content: 'Code';
                color: #000000;
                font-weight: 400;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .company-logo::after {
                content: 'Flex';
                color: #5B9BD5;
                font-weight: 400;
                text-shadow: 0 2px 4px rgba(91, 155, 213, 0.2);
            }

            @keyframes logoGlow {
                0% { 
                    filter: brightness(1);
                    transform: scale(1);
                }
                100% { 
                    filter: brightness(1.2);
                    transform: scale(1.02);
                }
            }

            .company-tagline {
                font-size: 16px;
                font-weight: 300;
                font-family: 'Segoe UI', 'Arial', sans-serif;
                color: rgba(255, 255, 255, 0.9);
                text-align: center;
                letter-spacing: 2px;
                text-transform: uppercase;
                margin-bottom: 15px;
                opacity: 0.9;
                animation: logoGlow 2s ease-in-out infinite alternate;
            }

            .loading-progress {
                width: 300px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                overflow: hidden;
                position: relative;
                opacity: 0.9;
                animation: logoGlow 2s ease-in-out infinite alternate;
            }

            .loading-progress::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, #5B9BD5, transparent);
                animation: loading-sweep 2s ease-in-out infinite;
            }

            @keyframes loading-sweep {
                0% { left: -100%; }
                100% { left: 100%; }
            }

            /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
            @media (max-width: 768px) {
                .panel-header {
                    font-size: 16px;
                    padding: 12px 15px;
                }
                
                .company-logo {
                    width: 80px;
                    height: 80px;
                }
                
                .company-tagline {
                    font-size: 18px;
                }
                
                .loading-progress {
                    width: 250px;
                }
            }
        </style>
    </head>
    <body tabindex="0">
        <!-- üè≠ Í≥µÏû• ÌÖåÎßà Î°úÎî© ÌôîÎ©¥ -->
        <div id="factory-loading" class="factory-loading">
            <div class="company-logo"></div>
            <div class="company-tagline">Digital Twin Solutions</div>
            <div class="loading-progress"></div>
        </div>
        
        <div class="main-container">
            <!-- Agent View -->
            <div class="left-panel">
                <div class="viewer-container">
                    <urdf-viewer up="+Z" display-shadow tabindex="0" urdf="urdf-loaders-master/urdf/INP3/INP3/INP3.urdf" autocenter></urdf-viewer>
                </div>
            </div>
        </div>

        <script type="module">
            // URDF Î∑∞Ïñ¥ Í¥ÄÎ†® Ïä§ÌÅ¨Î¶ΩÌä∏
            import * as THREE from 'three';
            import { STLLoader } from 'three/examples/jsm/loaders/STLLoader.js';
            import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
            import { ColladaLoader } from 'three/examples/jsm/loaders/ColladaLoader.js';
            import { OBJLoader } from 'three/examples/jsm/loaders/OBJLoader.js';
            import URDFManipulator from './urdf-loaders-master/javascript/src/urdf-manipulator-element.js';
            
            // URDF Î∑∞Ïñ¥ Ïª¥Ìè¨ÎÑåÌä∏ Îì±Î°ù
            customElements.define('urdf-viewer', URDFManipulator);
            
            // Î°úÎî© ÌôîÎ©¥ Ï†úÏñ¥ Ìï®ÏàòÎì§ (ÏõêÎ≥∏Í≥º ÎèôÏùº)
            function showFactoryLoading() {
                const loadingScreen = document.getElementById('factory-loading');
                if (loadingScreen) {
                    loadingScreen.classList.remove('hidden');
                    console.log('üè≠ Factory loading screen shown');
                }
            }

            function hideFactoryLoading() {
                const loadingScreen = document.getElementById('factory-loading');
                if (loadingScreen) {
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        console.log('üè≠ Factory loading screen hidden');
                    }, 200); // 0.2Ï¥à ÌõÑ Îπ†Î•¥Í≤å Ïà®ÍπÄ
                }
            }


            // Î°úÎî© ÌôîÎ©¥ ÌëúÏãú Î∞è ÏµúÏÜå ÏãúÍ∞Ñ Ï∂îÏ†Å (ÏõêÎ≥∏Í≥º ÎèôÏùº)
            const loadingStartTime = Date.now();
            showFactoryLoading();
            
            // URDF Î∑∞Ïñ¥ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ (Îπ†Î•∏ Ï¥àÍ∏∞Ìôî) - ÏõêÎ≥∏Í≥º ÎèôÏùº
            setTimeout(() => {
                const viewer = document.querySelector('urdf-viewer');
                if (viewer) {
                    console.log('URDF Viewer found and initialized');
                    
                    // Î∑∞Ïñ¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï - Ïã§Ï†ú Î™®Îç∏ Î°úÎî© ÏôÑÎ£å Í∞êÏßÄ
                    let urdfProcessed = false;
                    let geometryLoaded = false;
                    
                    viewer.addEventListener('urdf-processed', () => {
                        console.log('üìã URDF file processed');
                        urdfProcessed = true;
                        checkLoadingComplete();
                    });
                    
                    viewer.addEventListener('geometry-loaded', () => {
                        console.log('üéØ 3D Geometry loaded successfully');
                        geometryLoaded = true;
                        checkLoadingComplete();
                    });
                    
                    function checkLoadingComplete() {
                        if (urdfProcessed && geometryLoaded) {
                            console.log('‚úÖ All systems ready - checking minimum loading time');
                            
                            // ÏµúÏÜå 1.5Ï¥à Î°úÎî© ÏãúÍ∞Ñ Î≥¥Ïû•
                            const elapsedTime = Date.now() - loadingStartTime;
                            const remainingTime = Math.max(0, 1500 - elapsedTime);
                            
                            console.log(`‚è±Ô∏è Elapsed: ${elapsedTime}ms, Remaining: ${remainingTime}ms`);
                            
                            setTimeout(() => {
                                hideFactoryLoading();
                            }, remainingTime);
                        }
                    }
                } else {
                    console.warn('URDF Viewer not found');
                    // ÏóêÎü¨ ÏãúÏóêÎèÑ ÏµúÏÜå 1.5Ï¥à Î≥¥Ïû•
                    const elapsedTime = Date.now() - loadingStartTime;
                    const remainingTime = Math.max(0, 1500 - elapsedTime);
                    
                    setTimeout(() => {
                        hideFactoryLoading();
                    }, remainingTime);
                }
            }, 100);
            
            // ÌÉÄÏûÑÏïÑÏõÉ Î≥¥Ìò∏ (ÏõêÎ≥∏Í≥º ÎèôÏùº)
            setTimeout(() => {
                const loadingScreen = document.getElementById('factory-loading');
                if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                    console.log('‚ö†Ô∏è Loading timeout - forcing hide');
                    
                    // ÌÉÄÏûÑÏïÑÏõÉ ÏãúÏóêÎèÑ ÏµúÏÜå 1.5Ï¥à Î≥¥Ïû•
                    const elapsedTime = Date.now() - loadingStartTime;
                    const remainingTime = Math.max(0, 1500 - elapsedTime);
                    
                    setTimeout(() => {
                        hideFactoryLoading();
                    }, remainingTime);
                }
            }, 5000);
            
            // üè≠ WADF Full Assembly Sequence Îç∞Ïù¥ÌÑ∞ (websocket_server.pyÏóêÏÑú Ï∂îÏ∂ú)
            const WADF_ASSEMBLY_SEQUENCE = {
                1: [ // GRIPPER_TEST2_01: ÌîΩÏóÖ Ìè¨ÏßÄÏÖòÏúºÎ°ú Ïù¥Îèô
                    {joint: 'Rotation_31', value: -0.389, delay: 500}, // -22.3ÎèÑ
                    {joint: 'Rotation_36', value: 0.024, delay: 500},   // 1.4ÎèÑ
                    {joint: 'Rotation_151', value: 1.209, delay: 500}, // 69.3ÎèÑ
                    {joint: 'Slider_44', value: 0.0, delay: 500}
                ],
                2: [ // GRIPPER_TEST2_02: ZÏ∂ï ÌïòÍ∞ï (Î∂ÄÌíàÏúºÎ°ú)
                    {joint: 'Slider_44', value: -0.045, delay: 1000}
                ],
                3: [ // GRIPPER_TEST2_03: Í∑∏Î¶¨Ìçº Îã´Í∏∞
                    {joint: 'Slider_41', value: 0.0135, delay: 500},
                    {joint: 'Slider_42', value: 0.0135, delay: 500}
                ],
                7: [ // GRIPPER_TEST2_07: ZÏ∂ï ÏÉÅÏäπ (Î∂ÄÌíà Îì§Ïñ¥Ïò¨Î¶¨Í∏∞)
                    {joint: 'Slider_44', value: 0.0, delay: 1000}
                ],
                8: [ // GRIPPER_TEST2_08: Ï°∞Î¶Ω Ìè¨ÏßÄÏÖòÏúºÎ°ú Ïù¥Îèô
                    {joint: 'Rotation_31', value: 1.484, delay: 1000}, // 85ÎèÑ
                    {joint: 'Rotation_36', value: -1.134, delay: 1000},  // -65ÎèÑ
                    {joint: 'Rotation_151', value: 3.491, delay: 1000}  // 200ÎèÑ
                ],
                9: [ // GRIPPER_TEST2_09: Ï°∞Î¶ΩÏùÑ ÏúÑÌïú ZÏ∂ï ÌïòÍ∞ï
                    {joint: 'Slider_44', value: -0.02, delay: 800}
                ],
                10: [ // GRIPPER_TEST2_10: Ï†ïÎ∞Ä Ìè¨ÏßÄÏÖîÎãù (Îçî ÌïòÍ∞ï)
                    {joint: 'Slider_44', value: -0.04, delay: 1000}
                ],
                16: [ // GRIPPER_TEST2_16: Í∑∏Î¶¨Ìçº Ïó¥Í∏∞ (Î∂ÄÌíà Ìï¥Ï†ú)
                    {joint: 'Slider_41', value: 0.0, delay: 500},
                    {joint: 'Slider_42', value: 0.0, delay: 500}
                ],
                20: [ // GRIPPER_TEST2_20: ZÏ∂ï ÏÉÅÏäπ (Ï≤†Ïàò)
                    {joint: 'Slider_44', value: 0.0, delay: 1000}
                ],
                21: [ // GRIPPER_TEST2_21: Ìôà Ìè¨ÏßÄÏÖòÏúºÎ°ú Î≥µÍ∑Ä
                    {joint: 'Rotation_31', value: 0.0, delay: 1000},
                    {joint: 'Rotation_36', value: 0.0, delay: 1000},
                    {joint: 'Rotation_151', value: 1.571, delay: 1000}, // 90ÎèÑ
                    {joint: 'Slider_44', value: 0.0, delay: 1000}
                ]
            };

            // üè≠ Full Assembly Sequence Ïã§Ìñâ ÏàúÏÑú (websocket_server.pyÏóêÏÑú Ï∂îÏ∂ú)
            const FULL_ASSEMBLY_STEPS = [
                {step: 1, description: 'Check pallet arrival', delay: 100},
                {step: 2, gripper_test: 1, description: 'Move to pickup position', delay: 100},
                {step: 3, gripper_test: 2, description: 'Lower to part', delay: 100},
                {step: 4, gripper_test: 3, description: 'Close gripper', delay: 100},
                {step: 5, description: 'Activate assembly block', delay: 100},
                {step: 6, gripper_test: 7, description: 'Lift part', delay: 100},
                {step: 7, gripper_test: 8, description: 'Move to assembly position', delay: 100},
                {step: 8, gripper_test: 9, description: 'Lower to assembly', delay: 100},
                {step: 9, gripper_test: 10, description: 'Precise positioning', delay: 100},
                {step: 10, description: 'Activate engraving', delay: 100},
                {step: 11, description: 'Engraving process', delay: 100},
                {step: 12, gripper_test: 16, description: 'Open gripper', delay: 100},
                {step: 13, gripper_test: 20, description: 'Retract Z-axis', delay: 100},
                {step: 14, description: 'Push completed part', delay: 100},
                {step: 15, gripper_test: 21, description: 'Return home', delay: 100},
                {step: 16, description: 'Confirm part output', delay: 100},
                {step: 17, description: 'Move conveyor for next cycle', delay: 100}
            ];

            // üè≠ Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌïú Î≥¥Í∞Ñ Ìï®ÏàòÎì§
            function lerp(start, end, factor) {
                return start + (end - start) * factor;
            }

            // üè≠ Easing Ìï®ÏàòÎì§ (Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌï¥)
            function easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }

            function easeOutQuart(t) {
                return 1 - Math.pow(1 - t, 4);
            }

            function easeInOutSine(t) {
                return -(Math.cos(Math.PI * t) - 1) / 2;
            }

            // üè≠ Î∂ÄÎìúÎü¨Ïö¥ Ï°∞Ïù∏Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìï®Ïàò (Easing Ï†ÅÏö©)
            async function animateJointSmoothly(viewer, jointName, targetValue, duration = 1000, steps = 60) {
                if (!viewer) return;
                
                try {
                    // ÌòÑÏû¨ Ï°∞Ïù∏Ìä∏ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                    let currentValue = 0;
                    if (viewer.robot && viewer.robot.joints[jointName]) {
                        currentValue = viewer.robot.joints[jointName].angle || 0;
                    }
                    
                    const startValue = currentValue;
                    const stepDuration = duration / steps;
                    
                    // Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìñâ (Easing Ï†ÅÏö©)
                    for (let i = 0; i <= steps; i++) {
                        if (!animationRunning) break;
                        
                        const linearFactor = i / steps;
                        // Ï°∞Ïù∏Ìä∏ ÌÉÄÏûÖÏóê Îî∞Îùº Îã§Î•∏ easing Ï†ÅÏö©
                        let easedFactor;
                        if (jointName.includes('Rotation')) {
                            // ÌöåÏ†Ñ Ï°∞Ïù∏Ìä∏: Î∂ÄÎìúÎü¨Ïö¥ ÏãúÏûëÍ≥º ÎÅù
                            easedFactor = easeInOutSine(linearFactor);
                        } else if (jointName.includes('Slider')) {
                            // Ïä¨ÎùºÏù¥Îçî Ï°∞Ïù∏Ìä∏: ÏûêÏó∞Ïä§Îü¨Ïö¥ Í∞êÏÜç
                            easedFactor = easeOutQuart(linearFactor);
                        } else {
                            // Í∏∞Î≥∏: Î∂ÄÎìúÎü¨Ïö¥ ÏãúÏûëÍ≥º ÎÅù
                            easedFactor = easeInOutCubic(linearFactor);
                        }
                        
                        const currentStepValue = lerp(startValue, targetValue, easedFactor);
                        viewer.setJointValue(jointName, currentStepValue);
                        
                        // Î∂ÄÎìúÎü¨Ïö¥ ÌîÑÎ†àÏûÑ Í∞ÑÍ≤© (60fps)
                        await new Promise(resolve => setTimeout(resolve, stepDuration));
                    }
                    
                    console.log(`ü§ñ Joint ${jointName}: ${targetValue} (smooth animation completed)`);
                } catch (error) {
                    console.warn(`Smooth joint animation failed: ${error}`);
                    // Ïã§Ìå® Ïãú Ï¶âÏãú ÏÑ§Ï†ï
                    viewer.setJointValue(jointName, targetValue);
                }
            }

            // üè≠ ÎèôÏãú Ï°∞Ïù∏Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìï®Ïàò (Îçî Î∂ÄÎìúÎü¨Ïö¥ ÏõÄÏßÅÏûÑ)
            async function animateMultipleJointsSmoothly(viewer, jointSteps, duration = 1000) {
                if (!viewer || !jointSteps.length) return;
                
                const steps = 60; // 60fps
                const stepDuration = duration / steps;
                
                // Î™®Îì† Ï°∞Ïù∏Ìä∏Ïùò ÏãúÏûë Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                const startValues = {};
                for (let jointStep of jointSteps) {
                    if (viewer.robot && viewer.robot.joints[jointStep.joint]) {
                        startValues[jointStep.joint] = viewer.robot.joints[jointStep.joint].angle || 0;
                    } else {
                        startValues[jointStep.joint] = 0;
                    }
                }
                
                // Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìñâ
                for (let i = 0; i <= steps; i++) {
                    if (!animationRunning) break;
                    
                    const linearFactor = i / steps;
                    
                    // Í∞Å Ï°∞Ïù∏Ìä∏Î≥ÑÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò
                    for (let jointStep of jointSteps) {
                        const easedFactor = easeInOutSine(linearFactor);
                        const currentValue = lerp(startValues[jointStep.joint], jointStep.value, easedFactor);
                        viewer.setJointValue(jointStep.joint, currentValue);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, stepDuration));
                }
                
                console.log(`ü§ñ Multiple joints animated smoothly: ${jointSteps.map(j => j.joint).join(', ')}`);
            }

            // üè≠ ÏûêÎèô Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìñâ Ìï®Ïàò (Î∂ÄÎìúÎü¨Ïö¥ Î≤ÑÏ†Ñ)
            let animationRunning = false;
            let currentStepIndex = 0;

            async function executeFullAssemblySequence(viewer) {
                if (animationRunning) {
                    console.log('üè≠ Animation already running, skipping...');
                    return;
                }
                animationRunning = true;
                
                console.log('üè≠ Starting WADF Full Assembly Sequence (Smooth Animation)');
                
                try {
                    for (let stepInfo of FULL_ASSEMBLY_STEPS) {
                        if (!animationRunning) {
                            console.log('üè≠ Animation stopped by user');
                            break; // Ï§ëÎã® Ïãú Î£®ÌîÑ Ï¢ÖÎ£å
                        }
                        
                        console.log(`üè≠ Step ${stepInfo.step}: ${stepInfo.description}`);
                        
                        // GRIPPER_TEST2 Ïã§Ìñâ (Î∂ÄÎìúÎü¨Ïö¥ Ïï†ÎãàÎ©îÏù¥ÏÖò)
                        if (stepInfo.gripper_test && WADF_ASSEMBLY_SEQUENCE[stepInfo.gripper_test]) {
                            const sequence = WADF_ASSEMBLY_SEQUENCE[stepInfo.gripper_test];
                            
                            // ÎèôÏãúÏóê Ïó¨Îü¨ Ï°∞Ïù∏Ìä∏Î•º Î∂ÄÎìúÎüΩÍ≤å Ïï†ÎãàÎ©îÏù¥ÏÖò
                            if (sequence.length > 1) {
                                // Ïó¨Îü¨ Ï°∞Ïù∏Ìä∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞ ÎèôÏãú Ïï†ÎãàÎ©îÏù¥ÏÖò
                                const maxDelay = Math.max(...sequence.map(s => s.delay));
                                await animateMultipleJointsSmoothly(viewer, sequence, maxDelay);
                            } else {
                                // Îã®Ïùº Ï°∞Ïù∏Ìä∏Ïù∏ Í≤ΩÏö∞ Í∞úÎ≥Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
                                for (let jointStep of sequence) {
                                    if (!animationRunning) break;
                                    
                                    await animateJointSmoothly(
                                        viewer, 
                                        jointStep.joint, 
                                        jointStep.value, 
                                        jointStep.delay,
                                        60
                                    );
                                }
                            }
                        }
                        
                        // Îã®Í≥Ñ Í∞Ñ ÏßÄÏó∞ (Îçî Î∂ÄÎìúÎüΩÍ≤å)
                        await new Promise(resolve => setTimeout(resolve, stepInfo.delay));
                    }
                    
                    // ÏãúÌÄÄÏä§ ÏôÑÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú Îã§Ïãú ÏãúÏûë (Î¨¥Ìïú Î∞òÎ≥µ)
                    console.log('üè≠ Assembly sequence completed, preparing restart...');
                    
                } catch (error) {
                    console.error('üè≠ Animation error:', error);
                } finally {
                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
                    animationRunning = false;
                    
                    // 2Ï¥à ÌõÑ ÏûêÎèô Ïû¨ÏãúÏûë
                    setTimeout(() => {
                        console.log('üè≠ Restarting assembly sequence...');
                        executeFullAssemblySequence(viewer);
                    }, 2000);
                }
            }

            // URDF Î∑∞Ïñ¥ Ï¥àÍ∏∞Ìôî ÌôïÏù∏
            document.addEventListener('DOMContentLoaded', () => {
                const viewer = document.querySelector('urdf-viewer');
                if (viewer) {
                    console.log('Agent View URDF Viewer initialized successfully');
                    
                    // Ïπ¥Î©îÎùº Ï¥àÍ∏∞ ÏÑ§Ï†ï (4Î∞∞ ÌôïÎåÄ + 90ÎèÑ Î∞òÏãúÍ≥ÑÎ∞©Ìñ• ÌöåÏ†Ñ)
                    viewer.noAutoRecenter = false; // autocenter ÌôúÏÑ±Ìôî
                    
                    // Ïπ¥Î©îÎùº ÌôïÎåÄ Î∞è ÌöåÏ†Ñ ÏÑ§Ï†ï
                    viewer.addEventListener('urdf-processed', () => {
                        if (viewer.scene && viewer.camera) {
                            // Ïπ¥Î©îÎùº Í±∞Î¶¨Î•º 1/5.5Î°ú Ï§ÑÏó¨ÏÑú 5.5Î∞∞ ÌôïÎåÄ
                            const originalDistance = viewer.camera.position.length();
                            viewer.camera.position.multiplyScalar(1/5.5);
                            
                            // Ïπ¥Î©îÎùºÎ•º Î∞òÏãúÍ≥ÑÎ∞©Ìñ•ÏúºÎ°ú 150ÎèÑ ÌöåÏ†Ñ (YÏ∂ï Í∏∞Ï§Ä)
                            const rotationY = 150 * Math.PI / 180; // 150ÎèÑ (Î∞òÏãúÍ≥ÑÎ∞©Ìñ•)
                            viewer.camera.position.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotationY);
                            
                            // Ïπ¥Î©îÎùºÎ•º ÏúÑÏ™ΩÏúºÎ°ú Ïò¨Î¶¨Í∏∞
                            viewer.camera.position.y += 1.7; // Ïπ¥Î©îÎùº ÏûêÏ≤¥Î•º ÏúÑÎ°ú Ïò¨Î¶º
                            
                            // Ïπ¥Î©îÎùºÍ∞Ä Î™®Îç∏ÏùÑ Î∞îÎùºÎ≥¥ÎèÑÎ°ù ÏÑ§Ï†ï
                            if (viewer.robot) {
                                const robotCenter = new THREE.Vector3();
                                viewer.robot.getWorldPosition(robotCenter);
                                viewer.camera.lookAt(robotCenter);
                            }
                            
                            viewer.camera.updateProjectionMatrix();
                            console.log('üì∑ Camera zoomed 4x and rotated 90¬∞ counter-clockwise');
                            
                            // üè≠ URDF Î°úÎî© ÏôÑÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                            setTimeout(() => {
                                console.log('üè≠ Starting automatic assembly animation');
                                executeFullAssemblySequence(viewer);
                            }, 2000); // 2Ï¥à ÌõÑ ÏûêÎèô ÏãúÏûë
                        }
                    });
                    
                    // Î©îÏãú Î°úÎçî ÏÑ§Ï†ï (ÏõêÎ≥∏ ÏòàÏ†úÏôÄ ÎèôÏùº)
                    viewer.loadMeshFunc = (path, manager, done) => {
                        const ext = path.split(/\./g).pop().toLowerCase();
                        switch (ext) {
                            case 'gltf':
                            case 'glb':
                                new GLTFLoader(manager).load(
                                    path,
                                    result => done(result.scene),
                                    null,
                                    err => done(null, err),
                                );
                                break;
                            case 'obj':
                                new OBJLoader(manager).load(
                                    path,
                                    result => done(result),
                                    null,
                                    err => done(null, err),
                                );
                                break;
                            case 'dae':
                                new ColladaLoader(manager).load(
                                    path,
                                    result => done(result.scene),
                                    null,
                                    err => done(null, err),
                                );
                                break;
                            case 'stl':
                                new STLLoader(manager).load(
                                    path,
                                    result => {
                                        const material = new THREE.MeshPhongMaterial();
                                        const mesh = new THREE.Mesh(result, material);
                                        done(mesh);
                                    },
                                    null,
                                    err => done(null, err),
                                );
                                break;
                        }
                    };
                }
            });
        </script>
    </body>
</html>
